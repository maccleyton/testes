<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Editor HTML Puro (LaTeX + Código)</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .toolbar { display: flex; gap: 8px; padding: 8px; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #fff; }
    .toolbar button { padding: 6px 10px; cursor: pointer; }
    #editor { padding: 16px; min-height: 60vh; outline: none; }
    code { background: #f5f5f5; border: 1px solid #eee; border-radius: 4px; padding: 0 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    pre { background: #0b1020; color: #e6e6e6; padding: 12px; border-radius: 6px; overflow: auto; }
    pre code { background: transparent; border: 0; padding: 0; color: inherit; }
    .math-inline { display: inline-block; vertical-align: middle; }
    .math-block { display: block; margin: 12px 0; }
    .hint { color: #666; font-size: 14px; }
  </style>

  <!-- Inclua os arquivos locais do KaTeX (CSS + JS) -->
  <link rel="stylesheet" href="/vendor/katex/katex.min.css">
  <script defer src="/vendor/katex/katex.min.js"></script>
</head>
<body>
  <div class="toolbar">
    <button id="btn-math-inline">Renderizar seleção como fórmula (inline)</button>
    <button id="btn-math-block">Inserir fórmula (bloco)</button>
    <button id="btn-code-inline">Renderizar seleção como código (inline)</button>
    <button id="btn-code-block">Inserir código (bloco)</button>
  </div>

  <div id="editor" contenteditable="true">
    <p class="hint">Digite aqui. Selecione um trecho para renderizar como LaTeX inline ou código inline; use os botões de “Inserir” para criar blocos.</p>
  </div>

  <script>
    const editor = document.getElementById('editor')

    function ensureEditorFocus() { if (document.activeElement !== editor) editor.focus() }

    function selectionInEditor() {
      const sel = window.getSelection()
      if (!sel || sel.rangeCount === 0) return null
      const range = sel.getRangeAt(0)
      const container = range.commonAncestorContainer
      return editor.contains(container.nodeType === 1 ? container : container.parentNode) ? range : null
    }

    function replaceSelectionWith(node) {
      const range = selectionInEditor()
      if (!range) return
      range.deleteContents()
      range.insertNode(node)
      const sel = window.getSelection()
      sel.removeAllRanges()
      const after = document.createRange()
      after.setStartAfter(node)
      after.setEndAfter(node)
      sel.addRange(after)
    }

    function insertBlock(node) {
      const range = selectionInEditor()
      if (!range) return
      range.collapse(false)
      // separa do parágrafo atual, se necessário
      if (range.startContainer !== editor) {
        const breaker = document.createElement('p')
        breaker.innerHTML = '<br>'
        range.insertNode(breaker)
        range.setStartAfter(breaker)
        range.collapse(true)
      }
      range.insertNode(node)
      const p = document.createElement('p')
      p.innerHTML = '<br>'
      node.after(p)
      const sel = window.getSelection()
      sel.removeAllRanges()
      const after = document.createRange()
      after.selectNodeContents(p)
      after.collapse(true)
      sel.addRange(after)
    }

    function renderSelectionAsMathInline() {
      if (!window.katex) { alert('KaTeX não carregado.'); return }
      ensureEditorFocus()
      const range = selectionInEditor()
      if (!range) return
      const selText = range.toString().trim()
      const latex = selText.replace(/^\$+|\$+$/g, '') || prompt('LaTeX (inline):')
      if (!latex) return
      const span = document.createElement('span')
      span.className = 'math-inline'
      span.dataset.latex = latex
      try {
        window.katex.render(latex, span, { throwOnError: false, displayMode: false })
        replaceSelectionWith(span)
      } catch (e) {
        alert('Erro ao renderizar LaTeX inline.')
      }
    }

    function insertMathBlock() {
      if (!window.katex) { alert('KaTeX não carregado.'); return }
      ensureEditorFocus()
      const latex = prompt('LaTeX (bloco):')
      if (!latex) return
      const div = document.createElement('div')
      div.className = 'math-block'
      div.dataset.latex = latex
      try {
        window.katex.render(latex, div, { throwOnError: false, displayMode: true })
        insertBlock(div)
      } catch (e) {
        alert('Erro ao renderizar LaTeX em bloco.')
      }
    }

    function renderSelectionAsInlineCode() {
      ensureEditorFocus()
      const range = selectionInEditor()
      if (!range || range.collapsed) return
      const code = document.createElement('code')
      code.textContent = range.toString()
      replaceSelectionWith(code)
    }

    function insertCodeBlock() {
      ensureEditorFocus()
      const content = prompt('Conteúdo do código (opcional):') || ''
      const pre = document.createElement('pre')
      const code = document.createElement('code')
      code.textContent = content
      pre.appendChild(code)
      insertBlock(pre)
    }

    // Edição rápida de fórmulas no duplo clique
    editor.addEventListener('dblclick', (e) => {
      const el = e.target.closest('.math-inline, .math-block')
      if (!el) return
      const latex = prompt('Editar LaTeX:', el.dataset.latex || '')
      if (latex == null) return
      el.dataset.latex = latex
      try {
        const display = el.classList.contains('math-block')
        window.katex.render(latex, el, { throwOnError: false, displayMode: display })
      } catch (err) {
        alert('Erro ao renderizar LaTeX.')
      }
    })

    // Botões
    document.getElementById('btn-math-inline').addEventListener('click', renderSelectionAsMathInline)
    document.getElementById('btn-math-block').addEventListener('click', insertMathBlock)
    document.getElementById('btn-code-inline').addEventListener('click', renderSelectionAsInlineCode)
    document.getElementById('btn-code-block').addEventListener('click', insertCodeBlock)
  </script>
</body>
</html>
